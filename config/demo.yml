imports:
  - module: ./core/sources/demo
    source: demo
  - module: ./core/devices/httpcamera
    device: httpCamera
  - module: ./core/devices/device
    device: device
  - module: ./core/devices/sensor
    device: sensor
  - module: ./core/devices/variable
    device: variable
  - module: ./core/devices/group
    device: group
  - module: ipx800
    device: relay
  - module: proxiti
    source: astronomy
  - module: tempo
    source: tempo
  - module: ./core/sources/command
    source: command

sources:
  - myZibase: {
      type: demo
  }
  - myIPX800: {
      type: demo
  }
  - astronomy: {
      type: astronomy,
      location: "06030"
  }
  - myESPs: {
      type: demo
  }
  
  - tempo: { type: tempo }


devices:
  - aquarium:
    - controle : { type: variable, widget: "multistate:AUTO,ON,OFF:primary,secondary,danger", tags: 'aquarium-page', name: "Commande de l'aquarium"} 
    - pompes : { type: device, widget: toggle, tags: 'aquarium-page', source: myZibase, id: "ZC8", name: "Pompes aquarium" }
    - lampes : { type: device, widget: toggle, tags: 'aquarium-page', source: myZibase, id: "ZP7", name: "Lampes UV aquarium" }
    - lampes_start : { type: variable, widget: text, tags: 'aquarium', name: "Heure allumage aquarium" }
    - lampes_end : { type: variable, widget: text, tags: 'aquarium', name: "Heure extinction aquarium" }
    - pompes_start : { type: variable, widget: text, tags: 'aquarium', name: "Heure démarrage pompes aquarium" }
    - pompes_end : { type: variable, widget: text, tags: 'aquarium', name: "Heure arrêt pompes aquarium" }

  - sunset: { type: device, widget: text, tags: 'astronomy', source: astronomy, id: sunsetTime, name: "Coucher du soleil" }
  - sunset_plus_30mn: { type: variable, widget: text, tags: 'astronomy', name: "Coucher du soleil + 30mn" }
  - sunrise: { type: device, widget: text, tags: 'astronomy', source: astronomy, id: sunriseTime, name: "Lever du soleil" }
  - zenith: { type: device, widget: text, tags: 'astronomy', source: astronomy, id: zenithTime, name: "Zénith" }
  - daynight: { type: variable, widget: text, tags: 'astronomy', name: "Jour/nuit" }

  - camera_interieure: { type: httpCamera, widget: camera, tags: 'aquarium-page', video-url: /assets/imgs/demo_camera_interieure.jpg, snapshot-url: /assets/imgs/demo_camera_interieure.jpg, name: "Caméra intérieure" }
  - camera_exterieure: { type: httpCamera, widget: camera, tags: 'portails, entrée', video-url: /assets/imgs/demo_camera_exterieure.jpg, snapshot-url: /assets/imgs/demo_camera_exterieure.jpg, name: "Caméra extérieure" }
  - camera_piscine: { type: httpCamera, widget: camera, tags: 'piscine', video-url: /assets/imgs/demo_camera_piscine.jpg, snapshot-url: /assets/imgs/demo_camera_piscine.jpg, name: "Caméra piscine" }
  - alarme:
    - en_route: { type: device , widget: toggle, tags: 'alarme', source: myZibase, id: A1, name: "Alarme en route" }
    - presence : { type: variable, widget: text, tags: 'alarme', name: "Présence dans la maison"} 
    - sirene_interieure: { type: variable, widget: toggle, tags: 'alarme', source: myIPX800, id: 1, name: "Sirène intérieure" }
    - sirene_exterieure: { type: variable, widget: toggle, tags: 'alarme', source: myIPX800, id: 2, name: "Sirène extérieure" }
    - sensors: { type: group, widget: walkingman, tags: 'alarme', taglist: 'sensor-alarm', function:  !!js/function 'function (newValues, callback) {
            return callback(null, newValues.filter(v => v=="1").length > 0?"ON":"OFF");
          }', name: 'Détecteurs surveillés'}
    - presence-timeout : { type: variable, widget: text, tags: '', name: "Timeout présence (mn)"} 
    - fin-presence : { type: variable, widget: text, tags: 'alarme', name: "Heure de fin de présence"} 
  - garages:
    - porte: { type: sensor, widget: walkingman, tags: 'détecteurs, sensor-alarm', source: myIPX800, id: "INPUT5", name: "Porte garage du bas ou jardin", transform: "0=>OFF,1=>ON" }

  - bureau: { type: sensor, widget: walkingman, tags: 'détecteurs, sensor-alarm', source: myIPX800, id: "INPUT2", name: "Détecteur bureau", transform: "0=>OFF,1=>ON" }
  - salle_a_manger: { type: sensor, widget: walkingman, tags: 'détecteurs', source: myIPX800, id: "INPUT6", name: "Détecteur salle à manger", transform: "1=>OFF,0=>ON", camera: camera_interieure }
  - hall: { type: sensor, widget: walkingman, tags: 'détecteurs, sensor-timer, sensor-alarm', source: myIPX800, id: "INPUT3", name: "Détecteur hall", transform: "0=>OFF,1=>ON" }
  - escalier: { type: sensor, widget: walkingman, tags: 'détecteurs, sensor-timer, sensor-alarm', source: myIPX800, id: "INPUT4", name: "Détecteur escalier", transform: "0=>OFF,1=>ON" }
  - cuisine: { type: sensor, widget: walkingman, tags: 'détecteurs, sensor-alarm', source: myIPX800, id: "INPUT1", name: "Détecteur cuisine", transform: "0=>OFF,1=>ON" }

  - prise_camera: { type: device, widget: toggle, source: myZibase, id: "G2", name: "Prise Caméra" }




#rooms:
#  - cuisine:
#      name: Cuisine
#  - hall:
#      name: Hall

#zones:

#scenes:
#  - init:
#    - { actions: stairLightTimer, attribute: activated, value: true }
#    - { actions: hallLightTimer, attribute: activated, value: true }
#    - { actions: kitchenLightTimer, attribute: activated, value: true }
#  - normal:
#    - minuterie-hall:
#      - { actions: hallLightTimer, attribute: duration, value: 10:00 }
#    - aquarium:
#      - { actions: aquariumTimer, attribute: activated, value: true }
#  - invitation:
#    - minuterie-hall:
#      - { actions: hallLightTimer, attribute: duration, value: 15:00 }
#    - aquarium:
#      - { actions: aquariumTimer, attribute: activated, value: false }
#      - { device: lampes_aquarium, attribute: state, value: 'ON' }
#      - { device: pompes_aquarium, attribute: state, value: 'ON' }


  - lampes:
    - lampe_chambre_parents: { type: device, widget: toggle, tags: 'lampes-presence', source: myZibase, id: "ZA4", name: "Lampe Chambre parents" }
    - lampe_table_cuisine: { type: device, widget: toggle, tags: 'lampes-presence', source: myZibase , id: "ZP4", name: "Spots Table Cuisine" }
    - lampe_preau: { type: device, widget: toggle, tags: 'lampes-presence entrée', source: myZibase, id: "ZA5", name: "Lampe Préau" }
    - lampe_hall: { type: device, widget: toggle, tags: 'lampes-presence', source: myZibase, id: "ZC9", name: "Spots hall" }
    - lampe_rouge_haut: { type: device, widget: toggle, tags: 'lampes', source: myZibase, id: "ZO15", name: "Lampe rouge haut" }
    - lampe_rouge_bas: { type: device, widget: toggle, tags: 'lampes', source: myZibase, id: "ZC4", name: "Lampe rouge bas" }
    - lampe_escalier: { type: device, widget: toggle, tags: 'lampes-presence', source: myZibase, id: "ZB11", name: "Lampe escalier" }
    - nb_lampes: { type: group, widget: text, tags: 'lampes', function: count, taglist: 'lampes-presence', name: "Nombre de lampes" }
    - nb_lampes_ON: { type: group, widget: text, tags: 'lampes', function: !!js/function 'function (newValues, callback) {
          return callback(null, newValues.filter(v => v=="ON").length);
        }', taglist: 'lampes-presence', name: "Nombre de lampes allumées" }
    - couleur : { type: variable, widget: color, tags: 'lampes-couleur', name: "Couleur du widget de lampes"} 

  - piscine:
     - controle : { type: variable, widget: "multistate:AUTO,ON,OFF:primary,secondary,danger", tags: 'piscine', name: "Programmation filtration"} 
     - filtration: { type: device, widget: toggle, tags: 'piscine', source: myESPs, id: "04a87b", name: "Filtration piscine" }
     - pieuvre: { type: device, widget: toggle, tags: 'piscine', source: myZibase, id: "ZP8", name: "Pieuvre" }
     - chlore_plus: { type: device, widget: toggle, tags: 'piscine', source: myZibase, id: "ZA14", name: "Chlore +" }
     - chlore_moins: { type: device, widget: toggle, tags: 'piscine', source: myZibase, id: "ZO14", name: "Chlore -" }
     - temperature: { type: sensor, widget: text, tags: 'piscine', source: myZibase, id: "OS439157539", attribute: "tem", name: "Température" }
     - couleur : { type: variable, widget: color, tags: 'piscine', name: "Couleur de la température"} 
     - filtration-couleur : { type: variable, widget: color, tags: 'piscine', name: "Couleur de la filtration"} 
     - filtration-icon : { type: variable, widget: text, tags: 'piscine', name: "Icône de la filtration"} 
     - filtration-message : { type: variable, widget: text, tags: 'piscine', name: "Message de la filtration"} 
     - filtration-start1 : { type: variable, widget: text, tags: 'piscine', name: "Heure 1 de démarrage de la filtration"} 
     - filtration-stop1 : { type: variable, widget: text, tags: 'piscine', name: "Heure 1 d'arrêt de la filtration"} 
     - filtration-start2 : { type: variable, widget: text, tags: 'piscine', name: "Heure 2 de démarrage de la filtration"} 
     - filtration-stop2 : { type: variable, widget: text, tags: 'piscine', name: "Heure 2 d'arrêt de la filtration"} 
     - filtration-duration : { type: variable, widget: text, tags: 'piscine', name: "Durée de la filtration (heures)"} 
     - durees-filtration : { type: variable, widget: text, tags: 'piscine', name: "Tableau des durées de filtration [°C, h]"} 

  - petit_portail:
    - controle : { type: variable, widget: "confirm:Actionner:primary:Petit portail:Actionner le petit portail?:Partiel,Grand,Non", tags: 'portails-page, entrée', name: "Actionner le petit portail"} 
    - partiel: { type: device, widget: text, tags: 'portails', source: myZibase, id: "ZA3", name: "Petit Portail", camera: camera_exterieure }
    - grand: { type: device, widget: text, tags: 'portails', source: myZibase, id: "ZO10", name: "Petit Portail ouvert en grand", camera: camera_exterieure }
  - grand_portail:
    - controle : { type: variable, widget: "confirm:Actionner:primary:Grand portail:Actionner le grand portail?:Grand,Non", tags: 'portails-page', name: "Actionner le grand portail"} 
    - grand: { type: device, widget: text, tags: 'portails', source: myZibase, id: "ZA10", name: "Grand Portail" }
    - senseur_fermeture: { type: sensor, widget: text, tags: 'détecteurs, portails', source: myZibase, id: "ZB9", name: "Universal sensor Grand Portail", transform: !!js/function 'function (newValue) {
        return newValue == "1" ? "OFF" : "ON";
      }' }

  - tempo:
    - couleur_du_jour : { type: device, widget: tempo-color, tags: 'tempo', source: tempo, id: couleurDuJour, name: "Couleur du jour" }
    - couleur_de_demain : { type: device, widget: tempo-color, tags: 'tempo', source: tempo, id: couleurDeDemain, name: "Couleur de demain" }

  - hall-escalier:
    - controle : { type: variable, widget: "multistate:AUTO,MANU:primary,primary", tags: 'lampes', name: "Minuterie hall/escalier"} 
    - sensors: { type: group, widget: walkingman, tags: 'détecteurs', function: !!js/function 'function (newValues, callback) {
            return callback(null, newValues.filter(v => v=="1").length > 0?"ON":"OFF");
          }', name: "Détecteurs hall/escalier", taglist: "sensor-timer"}
    - timeout : { type: variable, widget: text, tags: '', name: "Timeout hall/escalier (mn)"} 
    - extinction : { type: variable, widget: text, tags: '', name: "Heure d'extinction hall/escalier"} 


  - cuisine:
    - controle : { type: variable, widget: "multistate:AUTO,MANU:primary,primary", tags: 'lampes', name: "Minuterie cuisine"} 
    - timeout : { type: variable, widget: text, tags: '', name: "Timeout cuisine (mn)"} 
    - extinction : { type: variable, widget: text, tags: '', name: "Heure d'extinction cuisine"} 



scenarios:
  - demo:
    - presence_simulator:
        triggers:
          - at: startup
        actions:
          - !!js/function 'function f(callback) {
            //return callback(null);
            var self = this;
            function pgm(device) {
              var onAt = 20000 + 60000 * Math.random(); 
              var offAt = onAt + 2000 + 30000 * Math.random(); 
              self.isReleased() || setTimeout(() => { 
                self.isReleased() || self.setDeviceState(device, "0");}, onAt);
              self.isReleased() || setTimeout(() => { 
                self.isReleased() || self.setDeviceState(device, "1"); pgm(device);}, offAt);
            }
            pgm("hall");
            pgm("escalier");
            pgm("cuisine");
            pgm("bureau");
            callback(null);
           }'
    - pool-temp_simulator:
        triggers:
          - cron: */30 * * * * *
        actions:
          - !!js/function 'function pool_temp(callback) {
              let MIN = -2; // min temperature
              let MAX = 32; // max temperature

              let prev_temp = parseFloat(this.getDeviceState("piscine.temperature") || (Date.now() % ((MAX - MIN)*10))/10 + MIN, 10);

              let temp = ((prev_temp * 10) % 2 == 0)?0.2:-0.2;
              temp = temp + prev_temp;

              if (temp > MAX) temp = MAX - 0.1; 
              if (temp < MIN) temp = MIN; 

              temp = temp.toFixed(1);

              this.setDeviceState("piscine.temperature", temp, callback);
            }'
  - aquarium:
    - set_end:
      triggers:
        - at: startup
        - cron: 01 00 00 * * *
      actions:
          - { device: aquarium.lampes_end, state: 23:30 }
          - { device: aquarium.pompes_end, state: 23:59 }
    - controle:
      - init:
        triggers:
          - at: startup
        actions:
            - { device: aquarium.controle, state: "AUTO" }
      - ON:
        triggers:
          - state: aquarium.controle
        conditions:
          - {operator: =, left: this.msg.newValue, right: "ON"}
        actions:
            - { device: aquarium.lampes, state: "ON" }
            - { device: aquarium.pompes, state: "ON" }
      - OFF:
        triggers:
          - state: aquarium.controle
        conditions:
          - {operator: =, left: this.msg.newValue, right: "OFF"}
        actions:
            - { device: aquarium.lampes, state: "OFF" }
            - { device: aquarium.pompes, state: "OFF" }
    - tempo:
      - set_Bleu:
          triggers:
            - state: tempo.couleur_du_jour
            - state: sunset_plus_30mn
          conditions:
            - {operator: =, left: tempo.couleur_du_jour, right: "Bleu"}
          actions:
            - {device: aquarium.pompes_start, state: sunset}
            - {device: aquarium.lampes_start, state: sunset_plus_30mn}
      - set_others:
          triggers:
            - state: tempo.couleur_du_jour
          conditions:
            - {operator: "!=", left: tempo.couleur_du_jour, right: "Bleu"}
          actions:
            - {device: aquarium.pompes_start, state: "21:30"}
            - {device: aquarium.lampes_start, state: "22:00"}
    - lampes:
      - start:
          triggers:
            - at: aquarium.lampes_start
          conditions:
            - {operator: =, left: aquarium.controle, right: "AUTO"}
          actions:
            - { device: aquarium.lampes, state: "ON" }
      - stop:
          triggers:
            - cron: 00 30 23 * * * 
          conditions:
            - {operator: =, left: aquarium.controle, right: "AUTO"}
          actions:
            - { device: aquarium.lampes, state: "OFF" }
    - pompes:
      - start:
          triggers:
            - at: aquarium.pompes_start
          conditions:
            - {operator: =, left: aquarium.controle, right: "AUTO"}
          actions:
            - { device: aquarium.pompes, state: "ON" }
      - stop:
          triggers:
            - cron: 00 59 23 * * *
          conditions:
            - {operator: =, left: aquarium.controle, right: "AUTO"}
          actions:
            - { device: aquarium.pompes, state: "OFF" }

  - astronomy:
    - sunset_calculation:
      triggers:
        - state: sunset
      actions:
        - !!js/function 'function f(callback) {
          let sunset = new Date(this.getDeviceState("sunset"));
          this.setDeviceState("sunset_plus_30mn", new Date(sunset.getTime() + 30 * 60 * 1000), callback);
        }'   
    - day:
      triggers:
        - at: sunrise
      actions:
        - { device: daynight, state: "jour"}
    - night:
      triggers:
        - at: sunset
      actions:
        - { device: daynight, state: "nuit"}
    - day-night:
      triggers:
        - state: sunset
        - state: sunrise
      conditions:
        - { operator: "!=", left: sunset, right: undefined}
        - { operator: "!=", left: sunrise, right: undefined}
      actions:
        - !!js/function 'function f(callback) {
          let sunset = new Date(this.getDeviceState("sunset"));
          let sunrise = new Date(this.getDeviceState("sunrise"));

          let now = Date.now();
          this.setDeviceState("daynight", (sunrise.getTime() < now && now < sunset.getTime())?"jour":"nuit", callback);
        }'   
  - presence:
    - init:
      triggers:
        - at: startup
      actions:
        - { device: alarme.presence-timeout, state: 10 }
    - run:
      - move:
        triggers:
          - state: alarme.sensors
        conditions:
          - { operator: =, left: alarme.sensors, right: "ON" }
        actions:
          - { device: alarme.presence, state: "ON"} 
      - still:
        triggers:
          - state: alarme.sensors
        conditions:
          - { operator: =, left: alarme.sensors, right: "OFF" }
        actions:
          - { device: alarme.fin-presence, state: new Date(Date.now() + this.getDeviceState("alarme.presence-timeout") * 60 * 1000)}
      - long-still:
        triggers:
          - at: alarme.presence-timeout

        actions:
          - { device: alarme.presence, state: "OFF"}






  - lampes:
    - lampes-couleur:
      triggers:
        - at: startup
        - state: lampes.nb_lampes
      actions:
          - !!js/function 'function f(callback) {
            let nb = this.getDeviceState("lampes.nb_lampes_ON");
            let color = "lightgrey"
            if (nb == 0) color = "#33cd5f"; // green
            else color = "#ef473a";           // red
            this.setDeviceState("lampes.couleur", color, callback);
          }'
  - piscine:
    - couleur:
        triggers:
          - state: piscine.temperature
        actions:
          - !!js/function 'function f(callback) {
            let temp = parseFloat(this.getDeviceState("piscine.temperature"), 10);
            var colors = [
              [ 0, "#ef473a"],    // red
              [ 0.1, "#886aea"],  // violet
              [ 28, "#33cd5f"],   // green
              [ 30, "#33cd5f"],   // green
              [ 33, "#ef473a"],   // red
            ];

            var color;
            if (temp <= colors[0][0]) {
              color = colors[0][1]
            } else if (temp >= colors[colors.length - 1][0]) {
              color = colors[colors.length - 1][1]
            } else {
              // find closest temp interval
              for (i = 0; i < colors.length - 1; i++) {
                if (temp >= colors[i][0] && temp < colors[i + 1][0]) {
                  // apply a gradient
                  color1 = colors[i][1];
                  r1 = parseInt(color1.substr(1, 2), 16);
                  g1 = parseInt(color1.substr(3, 2), 16);
                  b1 = parseInt(color1.substr(5, 2), 16);
                  color2 = colors[i + 1][1];
                  r2 = parseInt(color2.substr(1, 2), 16);
                  g2 = parseInt(color2.substr(3, 2), 16);
                  b2 = parseInt(color2.substr(5, 2), 16);
                  ratio = (temp - colors[i][0])/(colors[i + 1][0] - colors[i][0])
                  r = Math.round(r1 + ratio * (r2-r1));
                  g = Math.round(g1 + ratio * (g2-g1));
                  b = Math.round(b1 + ratio * (b2-b1));
                  color = "#" + r.toString(16) + g.toString(16) + b.toString(16);
                }
              }
            }
            this.setDeviceState("piscine.couleur", color, callback);
          }'   
    - controle:
      - init:
        triggers:
          - at: startup
        actions:
          - {device: piscine.controle, state: "AUTO" }
          - {device: piscine.filtration-icon, state: "timer" }
          - {device: piscine.filtration-couleur, state: "lightgrey" } 
      - AUTO:
        triggers:
          - state: piscine.controle
          - state: piscine.filtration
          - state: piscine.filtration-duration
        conditions:
          - {operator: =, left: piscine.controle, right: "AUTO"}
        actions:
          - {device: piscine.filtration-icon, state: "timer" }
      - ON:
        triggers:
          - state: piscine.controle
        conditions:
          - {operator: =, left: this.msg.newValue, right: "ON"}
        actions:
          - { device: piscine.filtration, state: "ON" }
      - OFF:
        triggers:
          - state: piscine.controle
        conditions:
          - {operator: =, left: this.msg.newValue, right: "OFF"}
        actions:
          - { device: piscine.filtration, state: "OFF" }
    - filtration-message:
      # computes filtration-message
      - init:
        triggers:
          - at: startup
        actions:
          - {device: piscine.filtration-message, state: "En attente..." } 
      - AUTO:
        # computes filtration-message
        # when the pool is in AUTO mode
        triggers:
          - state: piscine.controle
          - state: piscine.filtration
          - state: piscine.filtration-start1
          - state: piscine.filtration-duration
        conditions:
          - {operator: =, left: piscine.controle, right: "AUTO"}
          - {operator: "!=", left: piscine.filtration, right: undefined}
          - {operator: "!=", left: piscine.filtration-start1, right: undefined}
          - {operator: "!=", left: piscine.filtration-stop1, right: undefined}
          - {operator: "!=", left: piscine.filtration-duration, right: undefined}
        actions:
          - !!js/function 'function setFiltrationMessage (callback) {
            let msg = "";
            let filtration = this.getDeviceState("piscine.filtration");
            let duration = parseFloat(this.getDeviceState("piscine.filtration-duration"), 10) * 60;

            function displayAsTime(dateVal) {
              let now = new Date();
              let hh = dateVal.getHours();
              let mm = dateVal.getMinutes();
              let ss = dateVal.getSeconds();
              let yyyy = dateVal.getFullYear();
              let MM = dateVal.getMonth() + 1;
              let dd = dateVal.getDate();

              if (dateVal.getFullYear() === now.getFullYear()) {
                  if (dateVal.getMonth() === now.getMonth()) {
                      if (dateVal.getDate() === now.getDate()) return (hh<10?"0":"")+hh+":"+(mm<10?"0":"")+mm;
                      else if (dateVal.getDate() === now.getDate()-1) str = "hier";
                      else if (dateVal.getDate() === now.getDate()+1) str = "demain";
                      else str = (dd<10?"0":"")+dd+"/"+(MM<10?"0":"")+MM+"/"+yyyy;
                  } else str = (dd<10?"0":"")+dd+"/"+(MM<10?"0":"")+MM+"/"+yyyy;
              } else str = (dd<10?"0":"")+dd+"/"+(MM<10?"0":"")+MM+"/"+yyyy;
              str += " " + (hh<10?"0":"")+hh+":"+(mm<10?"0":"")+mm;
              return str;
            }            
            function displayAsDuration(duration) {
              var h = Math.floor(duration/60);
              var mn = Math.round(duration - 60*h);

              var str = "";
              if (h>0 && mn===0) str = h + "h";
              if (h>0 && mn>0) str = h + "h " + mn + "mn";
              if (h===0 && mn>0) str = mn + "mn";
              if (h===0 && mn===0) str = "0mn";
              return str;
            }
            let durationLength = displayAsDuration(duration);

            if (filtration != "ON") {
              let start1 = this.getDeviceState("piscine.filtration-start1");
              let _start1 = start1 && new Date(start1);
              let start2 = this.getDeviceState("piscine.filtration-start2");
              let _start2 = start2 && new Date(start2);
              let start = _start1 && _start1 > Date.now() ? _start1 : (_start2 && _start2 > Date.now() ? _start2 : undefined );
              let startTime = displayAsTime(start);
              msg = `Mise en<BR/>marche<br><strong>${startTime}</strong><br>pour ${durationLength}`;
            } 
            if (filtration == "ON") {
              let stop1 = this.getDeviceState("piscine.filtration-stop1");
              let _stop1 = stop1 && new Date(stop1);
              let stop2 = this.getDeviceState("piscine.filtration-stop2");
              let _stop2 = stop2 && new Date(stop2);
              let stop = _stop1 && _stop1 > Date.now() ? _stop1 : (_stop2 && _sstop2 > Date.now() ? _stop2 : undefined );
              let stopTime = displayAsTime(stop);
              msg = `Arrêt<br><strong>${stopTime}</strong><br>Durée<br>${durationLength}`;
            }
            this.setDeviceState("piscine.filtration-message", msg, callback);
          }'
      - ON:
        triggers:
          - state: piscine.controle
        conditions:
          - {operator: =, left: this.msg.newValue, right: "ON"}
        actions:
          - {device: piscine.filtration-message, state: "" } 
      - OFF:
        triggers:
          - state: piscine.controle
        conditions:
          - {operator: =, left: this.msg.newValue, right: "OFF"}
        actions:
          - {device: piscine.filtration-message, state: "" }
    - filtration-couleur:
      - AUTO-ON:
        triggers:
          - at: startup
          - state: piscine.filtration
          - state: piscine.controle
        conditions:
          - {operator: =, left: this.getDeviceState("piscine.controle"), right: "AUTO"}
          - {operator: =, left: this.getDeviceState("piscine.filtration"), right: "ON"}
        actions:
          - {device: piscine.filtration-couleur, state: "#33cd5f" } # green
          - {device: piscine.filtration-icon, state: "timer" }
      - AUTO-OFF:
        triggers:
          - at: startup
          - state: piscine.filtration
          - state: piscine.controle
        conditions:
          - {operator: =, left: this.getDeviceState("piscine.controle"), right: "AUTO"}
          - {operator: =, left: this.getDeviceState("piscine.filtration"), right: "OFF"}
        actions:
          - {device: piscine.filtration-couleur, state: "lightgrey" } 
          - {device: piscine.filtration-icon, state: "timer" }
      - ON-ON:
        triggers:
          - at: startup
          - state: piscine.controle
        conditions:
          - {operator: =, left: this.getDeviceState("piscine.controle"), right: "ON"}
          - {operator: =, left: this.getDeviceState("piscine.filtration"), right: "ON"}
        actions:
          - {device: piscine.filtration-couleur, state: "#33cd5f" } # green
          - {device: piscine.filtration-icon, state: "flash" }
      - ON-OFF:
        triggers:
          - at: startup
          - state: piscine.controle
          - state: piscine.filtration
        conditions:
          - {operator: =, left: this.getDeviceState("piscine.controle"), right: "ON"}
          - {operator: =, left: this.getDeviceState("piscine.filtration"), right: "OFF"}
        actions:
          - {device: piscine.filtration-couleur, state: "#ef473a" } # red
          - {device: piscine.filtration-icon, state: "flash" }
          - {device: piscine.controle, state: "OFF" }
      - OFF-OFF:
        triggers:
          - at: startup
          - state: piscine.controle
          - state: piscine.filtration
        conditions:
          - {operator: =, left: this.getDeviceState("piscine.controle"), right: "OFF"}
          - {operator: =, left: this.getDeviceState("piscine.filtration"), right: "OFF"}
        actions:
          - {device: piscine.filtration-couleur, state: "#ef473a" } # red
          - {device: piscine.filtration-icon, state: "power" }
      - OFF-ON:
        triggers:
          - at: startup
          - state: piscine.controle
          - state: piscine.filtration
        conditions:
          - {operator: =, left: this.getDeviceState("piscine.controle"), right: "OFF"}
          - {operator: =, left: this.getDeviceState("piscine.filtration"), right: "ON"}
        actions:
          - {device: piscine.filtration-couleur, state: "#ef473a" } # red
          - {device: piscine.filtration-icon, state: "power" }
          - {device: piscine.controle, state: "ON" }
    - filtration-duree-start:
      - init:
        triggers:
          - at: startup
        actions:
          # tableau des durées de filtration [ °C, durée en heures ]
          - {device: piscine.durees-filtration, state: "[
              [10, 3],    
              [13, 3],
              [16, 7],
              [20, 11],
              [24, 15],
              [27, 20],
              [30, 24]
            ]
            "}
      - calcul-duree:
        triggers:
          - state: piscine.temperature
        actions:
          - !!js/function 'function f(callback) {
            let temp = parseFloat(this.getDeviceState("piscine.temperature"), 10);
            let durees = JSON.parse(this.getDeviceState("piscine.durees-filtration"));

            var duree;
            if (temp <= durees[0][0]) {
              duree = durees[0][1]
            } else if (temp >= durees[durees.length - 1][0]) {
              duree = durees[durees.length - 1][1]
            } else {
              // find closest temp interval
              for (i = 0; i < durees.length - 1; i++) {
                if (temp >= durees[i][0] && temp < durees[i + 1][0]) {
                  // apply a gradient
                  duree1 = durees[i][1];
                  duree2 = durees[i + 1][1];
                  ratio = (temp - durees[i][0])/(durees[i + 1][0] - durees[i][0]);
                  duree = duree1 + ratio * (duree2-duree1);
                }
              }
            }
            // avoid unwanted stop/start
            if (duree > 23 + 50/60) duree=24;
            this.setDeviceState("piscine.filtration-duration", duree, callback);
          }'         
      - calcul-start:
        triggers:
          - state: zenith
          - state: piscine.filtration-duration
        conditions:
          - { operator: "!=", left: piscine.filtration-duration, right: undefined}
          - { operator: "!=", left: zenith, right: undefined}
          #- { operator: "!=", left: piscine.filtration, right: "ON"}
        actions:
          - !!js/function 'function f(callback) {
            let dureeTotale = parseFloat(this.getDeviceState("piscine.filtration-duration"), 10);

            let zenith = new Date(this.getDeviceState("zenith"));

            let previous_start1 = (new Date(this.getDeviceState("piscine.filtration-start1"))).getTime();

            let start2Date = new Date();
            start2Date.setHours(23);
            start2Date.setMinutes(00);
            start2Date.setSeconds(00);
            let start2 = start2Date.getTime();
            let stop2 = start2 + 59 * 60 * 1000;
            // check if next day
            if (stop2 < Date.now()) {
              console.log("2 is next day")
              start2 = start2 + 24 * 60 * 60 * 1000;
              stop2 = stop2 + 24 * 60 * 60 * 1000;
            }

            let duree = dureeTotale - (stop2 - start2) / 60 / 60 / 1000;
            console.log("duree", duree, "total", dureeTotale);

            let start1 = zenith.getTime() - duree * 60 * 60 * 1000 / 2;

            if (start1 < Date.now() + 5 * 60 * 1000) {
              // start1 is almost in the past (5 mn), probably because the temperature is increasing.
              console.log("start1 before 5 mn!!! Let s use previous_start1:", previous_start1)
              start1 = previous_start1;
              // if not defined yet, probably because the first time it is called. Let s start asap
              if (!start1 || new Date(start1).toString() == "Invalid Date") {
                start1 = Date.now() + 3 * 60 * 1000;
                console.log("start1 new Date + 3 = ", start1)
                console.log("previous_start1 was not defined!!! Let s start asap in 3 mn at", start1)
              }
            }

            let stop1 = start1 + duree * 60 * 60 * 1000;
            // check if next day
            if (stop1 < Date.now()) {
              console.log("1 is next day")
              start1 = start1 + 24 * 60 * 60 * 1000;
              stop1 = stop1 + 24 * 60 * 60 * 1000;
            }

            console.log("start1", new Date(start1).toString())
            console.log("stop1", new Date(stop1).toString())
            console.log("start2", new Date(start2).toString())
            console.log("stop2", new Date(stop2).toString())

            // check full time
            if (dureeTotale > 24 - 10/60) {
              stop1 = undefined;
              start2 = undefined;
              stop2 = undefined;
            } else {
              // check overlaps

              // start1 ---------------- stop1
              //              start2 --------------- stop2
              if (start1 && start2 && stop1 && stop2 && start1 < start2 && stop1 > start2 && stop1 < stop2) {
                console.log("chevauchant")
                start2 = undefined;
                stop1 = undefined;
              }

              // start1 ----------------------------- stop1
              //              start2 ----- stop2
              if (start1 && start2 && stop1 && stop2 && start1 < start2 && stop1 > stop2) {
                console.log("inclus")
                start2 = undefined;
                stop2 = undefined;
              }

              // start1 ------ stop1    start2 ----- stop2
              //              <--------------> 
              //                    < 5 mn
              if (stop1 && start2 && Math.abs(stop1 - start2) < 5 * 60 * 1000) {
                console.log("tres prets")
                start2 = undefined;
                stop1 = undefined;
              }

            }

            console.log("=>start1", new Date(start1).toString())
            console.log("=>stop1", new Date(stop1).toString())
            console.log("=>start2", new Date(start2).toString())
            console.log("=>stop2", new Date(stop2).toString())


            //console.log(new Date(start1).toString(), new Date(start2).toString())

            start1 && this.setDeviceState("piscine.filtration-start1", new Date(start1));
            stop1 && this.setDeviceState("piscine.filtration-stop1", new Date(stop1));
            start2 && this.setDeviceState("piscine.filtration-start2", new Date(start2));
            stop2 && this.setDeviceState("piscine.filtration-stop2", new Date(stop2), callback);
            stop2 || callback();
          }'    
    - filtration-start:
      triggers:
        - at: piscine.filtration-start1
        - at: piscine.filtration-start2
      conditions:
        - {operator: =, left: piscine.controle, right: "AUTO"} 
      actions:
        - !!js/function 'function f(callback) {
            let delay = 15 * 1000; // 15s

            let date = this.getDeviceLastUpdateDate("piscine.filtration");

            if (!date || Date.now() - date.getTime() >= delay ) { 
              this.setDeviceState("piscine.filtration", "ON", callback);
            } else {
              setTimeout(() => { f(callback); }, delay);
            }
          }' 
    - filtration-stop:
      triggers:
        - at: piscine.filtration-stop1
        - at: piscine.filtration-stop2
      conditions:
        - {operator: =, left: piscine.controle, right: "AUTO"} 
      actions:
        - !!js/function 'function f(callback) {
            let delay = 15 * 1000; // 15s

            let date = this.getDeviceLastUpdateDate("piscine.filtration");

            if (!date || Date.now() - date.getTime() >= delay ) { 
              this.setDeviceState("piscine.filtration", "OFF", callback);
            } else {
              setTimeout(() => { f(callback); }, delay);
            }
          }' 
  - petit_portail:
    - controle:
      - init:
        triggers:
          - at: startup
        actions:
            - { device: petit_portail.controle, state: "OFF" }
      - partiel:
        triggers:
          - state: petit_portail.controle
        conditions:
          - {operator: =, left: this.msg.newValue, right: "Partiel"}
        actions:
            - { device: petit_portail.partiel, state: "ON" }
            - { device: petit_portail.controle, state: "OFF" }
      - grand:
        triggers:
          - state: petit_portail.controle
        conditions:
          - {operator: =, left: this.msg.newValue, right: "Grand"}
        actions:
            - { device: petit_portail.grand, state: "ON" }
            - { device: petit_portail.controle, state: "OFF" }
  - grand_portail:
    - controle:
      - init:
        triggers:
          - at: startup
        actions:
            - { device: grand_portail.controle, state: "OFF" }
      - grand:
        triggers:
          - state: grand_portail.controle
        conditions:
          - {operator: =, left: this.msg.newValue, right: "Grand"}
        actions:
            - { device: grand_portail.grand, state: "ON" }
            - { device: grand_portail.controle, state: "OFF" }  
  - minuteries:
    - controle:
      - init:
        triggers:
          - at: startup
        actions:
            - { device: hall-escalier.controle, state: "AUTO" }
            - { device: cuisine.controle, state: "AUTO" }
    - setup:
      triggers:
        - at: startup
      actions:
        # durée de la minuterie du hall
        - {device: hall-escalier.timeout, state: "3"}
        # durée de la minuterie de la cuisine
        - {device: cuisine.timeout, state: "5"}

    - timer-cuisine:
      - ON:
        triggers:
          - state: cuisine
        conditions:
          - controle: { operator: =, left: cuisine.controle, right: "AUTO" }
          - { operator: =, left: cuisine, right: "1" }
          - night: { operator: =, left: daynight, right: "nuit" }   
        actions:
          - {device: lampes.lampe_table_cuisine, state: "ON"}
          - {device: cuisine.extinction, state: "" }      
      - OFF:
        triggers:
          - at: startup
          - state: cuisine
          - state: cuisine.controle
        conditions:
          - controle: { operator: =, left: cuisine.controle, right: "AUTO" }
          - { operator: "!=", left: cuisine, right: "1" }
        actions:
          - {device: cuisine.extinction, state: new Date(Date.now() + getDeviceState("cuisine.timeout") * 60 * 1000) }      
      - timeout:
        triggers:
          - at: cuisine.extinction
        conditions:
          - controle: { operator: =, left: cuisine.controle, right: "AUTO" }
          - { operator: "!=", left: cuisine.extinction, right: "" }
        actions:
          - {device: lampes.lampe_table_cuisine, state: "OFF"}
    - timer-hall-escalier:
      - hall-ON:
        triggers:
          - state: hall
        conditions:
          - controle: { operator: =, left: hall-escalier.controle, right: "AUTO" }
          - { operator: =, left: hall, right: "1" }
          - night: { operator: =, left: daynight, right: "nuit" }   
        actions:
          - {device: lampes.lampe_hall, state: "ON"}
          - {device: lampes.lampe_escalier, state: "ON"}
          - {device: hall-escalier.extinction, state: "" }
      - escalier-ON:
        triggers:
          - state: escalier
        conditions:
          - controle: { operator: =, left: hall-escalier.controle, right: "AUTO" }
          - { operator: =, left: escalier, right: "1" }
          - night: { operator: =, left: daynight, right: "nuit" }   
        actions:
          - {device: lampes.lampe_escalier, state: "ON"}
          - {device: lampes.lampe_hall, state: "ON"}
          - {device: hall-escalier.extinction, state: "" }      
      - OFF:
        triggers:
          - at: startup
          - state: hall
          - state: escalier
          - state: hall-escalier.controle
        conditions:
          - controle: { operator: =, left: hall-escalier.controle, right: "AUTO" }
          - { operator: "!=", left: hall, right: "1" }
          - { operator: "!=", left: escalier, right: "1" }
        actions:
          - {device: hall-escalier.extinction, state: new Date(Date.now() + getDeviceState("hall-escalier.timeout") * 60 * 1000) }      
      - timeout:
        triggers:
          - at: hall-escalier.extinction
        conditions:
          - controle: { operator: =, left: hall-escalier.controle, right: "AUTO" }
          - { operator: "!=", left: hall-escalier.extinction, right: "" }
        actions:
          - {device: lampes.lampe_escalier, state: "OFF"}
          - {device: lampes.lampe_hall, state: "OFF"}

pages:
  - Home:
      title: 'Tableau de bord'
      page: home.html
      args: 
        - widgets: 
          - pool-temp:
            widget: dashboard-icon
            icon: "thermometer" # a valid ionic icon name
            linkPage: Piscine
            label: "Piscine"
            color: "${piscine.couleur}"
            text: "<h1><BR/><strong>${piscine.temperature}</strong><BR/>°C</h1>"
          - pool-filtration:
            widget: dashboard-icon
            icon: "${piscine.filtration-icon}" # a valid ionic icon name
            linkPage: Piscine
            label: "Filtration ${piscine.filtration}"
            color: "${piscine.filtration-couleur}"
            text: "${piscine.filtration-message}"
          - entrée:
            widget: dashboard-camera
            url: /assets/imgs/demo_dashboard_entrée.jpg
            linkPage: Entrée
            label: "Entrée"
          - aquarium:
            widget: dashboard-camera
            url: /assets/imgs/demo_dashboard_aquarium.jpg
            linkPage: Aquarium
            label: "Aquarium ${aquarium.lampes}"
          - piscine:
            widget: dashboard-camera
            url: /assets/imgs/demo_dashboard_piscine.jpg
            linkPage: Piscine
            label: Piscine
          - lights:
            widget: dashboard-icon
            icon: "bulb" # a valid ionic icon name
            color: "${lampes.couleur}"
            linkPage: Lampes
            label: "Lampes"
            text: "<h1>${lampes.nb_lampes_ON}/${lampes.nb_lampes}</br></h1>"
          - portails:
            widget: dashboard-icon
            icon: ios-barcode # a valid ionic icon name
            linkPage: Portails
            label: Portails
          - tempo:
            widget: dashboard-tempo
            couleurDuJour: "${tempo.couleur_du_jour}"
            couleurDeDemain: "${tempo.couleur_de_demain}"
            label: "Tempo"           
          - users:
            widget: dashboard-icon
            icon: people # a valid ionic icon name
            label: "Utilisateurs"
          - debug:
            widget: dashboard-icon
            icon: ios-bug # a valid ionic icon name
            linkPage: Devices
            label: "Debug"
  - Aquarium:
      title: 'Aquarium'
      page: list.html
      args: 
        - tag-list: 'aquarium-page'
        - headers: false
  - Entrée:
      title: "Entrée"
      page: list.html
      args: 
        - tag-list: 'entrée'
        - headers: false
  - Portails:
      title: "Portails"
      page: list.html
      args: 
        - tag-list: 'portails-page'
        - headers: false
  - Lampes:
      title: 'Lampes'
      page: list.html
      args: 
        - tag-list: 'lampes*:lampes'
  - Devices:
      title: 'Tous les devices'
      page: list.html
      args: 
        - tag-list: 'alarme, lampes*:lampes, détecteurs, websockets, piscine, aquarium*:aquarium, portails*:portails, astronomy, tempo, *:autres'
        - image-size: tiny
  - About:
      menu-item: 'A propos'
      title: 'A propos'
      page: about.html


users:
  - id: -1 # must be unique
    name: 'Homebridge'
    initials: 'HB'
    login: hb
    password: hbpassword01
    phone: phone_4
    macaddress: ''
    avatar: ...
  - id: 0 # must be unique
    name: 'demouser'
    initials: 'du'
    login: demo
    password: demo
    phone: phone_1
    macaddress: 'e4:b5:26:3a:73:ac'
    avatar: ...  
  - id: 1 # must be unique
    name: 'Luc'
    initials: 'LC'
    login: Luc
    password: demo
    phone: phone_1
    macaddress: 'e0:b5:2d:3a:76:ab'
    avatar: ...
  - id: 2 # must be unique
    name: 'Karen'
    initials: 'KC'
    login: Karen
    password: demo
    phone: phone_2
    macaddress: 'd8:c2:6a:bc:b3:2c'
    avatar: ...
  - id: 3 # must be unique
    name: 'Stéphane'
    initials: 'SC'
    login: Stéphane
    password: demo
    phone: phone_3
    macaddress: '40:6A:AE:6F:D7:45'
    avatar: ...
  - id: 4 # must be unique
    name: 'Nathalie'
    initials: 'NC'
    login: Nathalie
    password: demo
    phone: phone_4
    macaddress: 'B1:A2:E7:83:96:CB'
    avatar: ...




